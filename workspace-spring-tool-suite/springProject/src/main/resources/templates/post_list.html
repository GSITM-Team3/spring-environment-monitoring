<!DOCTYPE html>
<html layout:decorate="~{layout}">

<head>
	<title>Community</title>
	<style>
		.post-image {
			width: 350px;
			height: 300px;
		}

		.genderIcon {
			border-radius: 50%;
			border: 1px solid black;
			padding: 5px;
			margin-right: 10px;
			width: 30px;
		}

		.content-column {
			width: 50%;
			/* 내용 컬럼 너비 조정 */
		}

		.comment-column {
			width: 30%;
			/* 댓글 컬럼 너비 조정 */
		}

		.comment-list-wrapper {
			max-height: 150px;
			/* 최대 높이 설정 (약 3개의 댓글 높이) */
			overflow-y: auto;
			/* 세로 스크롤바 추가 */
			padding: 10px;
		}

		.comment {
			margin-bottom: 3px;
			/* 댓글 간격 조정 */
		}

		/* 테이블 크기 고정 */
		.table-fixed {
			table-layout: fixed;
			width: 100%;
		}

		.like-btn,
		.liked {
			border: none;
			/* 테두리 없애기 */
			background: none;
			/* 배경 없애기 */
			cursor: pointer;
			/* 마우스 포인터 모양 변경 */
			outline: none;
			/* 포커스시 테두리 제거 */
		}
	</style>
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script type="text/javascript" th:inline="javascript">
		$(document).ready(function () {
			$(document).on('click', '.like-btn', function () {
				console.log("클릭 이벤트");
				var postId = $(this).data('post-id');
				var liked = $(this).hasClass('liked'); // 이미 좋아요 누른 경우 여부

				console.log(postId);
				console.log(liked);
				// CSRF 토큰 가져오기
				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content")

				var $button = $(this); // 클로저 안에서 $(this)를 안전하게 사용하기 위해 변수에 저장

				$.ajax({
					url: '/like/' + postId,
					type: 'POST',
					beforeSend: function (xhr) {
						// 요청 헤더에 CSRF 토큰 추가
						xhr.setRequestHeader(header, token);
					},
					success: function (response) {
						if (response === 'liked') {
							// 좋아요 추가 성공
							$button.addClass('liked');
						} else if (response === 'unliked') {
							// 좋아요 취소 성공
							$button.removeClass('liked');
						}
						console.log('AJAX 요청 성공:', response);
						location.reload();
					},
					error: function (xhr, status, error) {
						console.error('AJAX 요청 실패:', status, error);
					}
				});

			});

		});
	</script>
	<script th:inline="javascript">
		$(document).ready(function () {
			$('.delete-comment').click(function (event) {
				event.preventDefault(); // 링크 기본 동작 취소

				var commentId = $(this).data('comment-id');
				var page = $(this).data('page');

				if (confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
					$.ajax({
						type: "GET",
						url: "/comment/delete/" + commentId + "?page=" + page,
						success: function () {
							window.location.href = "/community?page=" + page; // 페이지 이동
						},
						error: function () {
							alert('댓글 삭제에 실패했습니다.');
						}
					});
				}
			});
		});
	</script>
</head>

<body>
	<div class="container my-3" layout:fragment="content">
		<h1>Post List</h1>
		<table class="table table-fixed">
			<tbody>
				<tr th:each="post, loop : ${paging}">
					<td style="width: 380px;">
						<a style="text-decoration-line: none;" th:href="@{/post/detail/{id}(id=${post.id})}">
							<img th:src="${post.imagePath}" class="post-image" alt="Post Image">
						</a>
						<cite title="Source Title">
							<p th:text="'#' + ${post.location}"></p>
						</cite>
						<!-- 좋아요 아이콘 표시 -->
						<div id="like">
							<button th:if="${not post.loggedInUserLiked}" class="like-btn"
								th:attr="data-post-id=${post.id}">
								<!-- 접속한 유저가 이 게시물에 좋아요를 누르지 않은 경우 -->
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="red"
									class="bi bi-heart" viewBox="0 0 16 16">
									<path
										d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15" />
								</svg>
							</button>
							<button th:if="${post.loggedInUserLiked}" class="like-btn liked"
								th:attr="data-post-id=${post.id}">
								<!-- 접속한 유저가 이 게시물에 좋아요를 누른 경우 -->
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="red"
									class="bi bi-heart-fill" viewBox="0 0 16 16">
									<path fill-rule="evenodd"
										d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
								</svg>
							</button>
						</div>
						<div>좋아요 갯수</div>
						<div th:text="${post.likeCount}"></div>
					</td>
					<td class="content-column">
						<div>
							<div style="display: flex;">
								<div>
									<img th:if="${post.userTable.gender == 'male'}" class="genderIcon"
										th:src="@{/uploads/male.PNG}" alt="남자 이미지">
									<img th:if="${post.userTable.gender == 'female'}" class="genderIcon"
										th:src="@{/uploads/female.PNG}" alt="여자 이미지">
								</div>
								<p th:if="${post.userTable != null}" th:text="${post.userTable.loginId}"
									style="font-weight: bold;"></p>
							</div>
							<figure>
								<blockquote class="blockquote">
									<a style="text-decoration-line: none;" th:href="@{/post/detail/{id}(id=${post.id})}"
										th:text="${post.content}"></a>
								</blockquote>
								<figcaption class="blockquote-footer" th:if="${post.updatedAt != null}">
									<span th:text="${#temporals.format(post.updatedAt, 'yyyy-MM-dd HH:mm')}"></span>
								</figcaption>
								<figcaption class="blockquote-footer" th:unless="${post.updatedAt != null}">
									<span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
								</figcaption>
							</figure>
						</div>
					</td>
					<td class="comment-column">
						<form th:action="@{/community}" th:method="post" class="form-inline">
							<input type="hidden" name="postId" th:value="${post.id}">
							<input type="hidden" name="page" th:value="${paging.number}">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
							<div class="form-group mr-2 mb-0" style="display: flex;">
								<textarea class="form-control" id="comment" name="content" rows="1" style="width: 70%"
									placeholder="댓글을 입력해주세요" required></textarea>
								<button type="submit" class="btn btn-primary mb-0"
									style="margin-left: 15px;">등록</button>
							</div>
						</form>

						<div class="comment-list-wrapper">
							<div class="comment d-flex" th:each="comment : ${post.comment}">
								<div>
									<img th:if="${comment.userTable.gender == 'male'}" class="genderIcon"
										th:src="@{/uploads/male.PNG}" alt="남자 이미지">
									<img th:if="${comment.userTable.gender == 'female'}" class="genderIcon"
										th:src="@{/uploads/female.PNG}" alt="여자 이미지">
								</div>
								<p th:if="${comment.userTable != null}" th:text="${comment.userTable.loginId}"
									style="font-weight: bold; margin-right: 15px;"></p>
								<span th:text="${comment.content}"></span>
								<a href="#" class="delete-comment"
									th:attr="data-comment-id=${comment.id}, data-page=${paging.number}"
									sec:authorize="isAuthenticated()"
									th:if="${comment.userTable.loginId != null and #authentication.getPrincipal().getUsername()==comment.userTable.loginId}">
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
										class="bi bi-x-circle" viewBox="0 0 16 16">
										<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16">
										</path>
										<path
											d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708">
										</path>
									</svg>
								</a>
							</div>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
		<!-- 페이징처리 시작 -->
		<div th:if="${!paging.isEmpty()}">
			<ul class="pagination justify-content-center">
				<li class="page-item" th:classappend="${!paging.hasPrevious} ? 'disabled'">
					<a class="page-link" th:href="@{|?page=${paging.number-1}|}">
						<span>이전</span>
					</a>
				</li>
				<li th:each="page: ${#numbers.sequence(0, paging.totalPages-1)}"
					th:if="${page >= paging.number-5 and page <= paging.number+5}"
					th:classappend="${page == paging.number} ? 'active'" class="page-item">
					<a th:text="${page+1}" class="page-link" th:href="@{|?page=${page}|}"></a>
				</li>
				<li class="page-item" th:classappend="${!paging.hasNext} ? 'disabled'">
					<a class="page-link" th:href="@{|?page=${paging.number+1}|}">
						<span>다음</span>
					</a>
				</li>
			</ul>
		</div>
		<!-- 페이징처리 끝 -->
		<button class="btn btn-primary">
			<a th:href="@{/post/create}" class="text-light" style="text-decoration-line: none;">글쓰기</a>
		</button>
	</div>
</body>

</html>