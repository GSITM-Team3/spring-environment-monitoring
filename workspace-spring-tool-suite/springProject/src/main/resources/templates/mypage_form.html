<!DOCTYPE html>
<html layout:decorate="~{layout}">

<head>
	<title>MyPage</title>
	<style>
		.form-container {
			max-width: 600px;
			margin: 0 auto;
			padding: 20px;
			background-color: #fff;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			margin-top: 50px;
		}

		.gender label {
			margin-left: 20px;
		}

		.gender input {
			margin-left: 10px;
		}

		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			z-index: 1000;
			overflow: auto;
		}

		.modal-content {
			background-color: #fefefe;
			margin: 15% auto;
			padding: 20px;
			border: 1px solid #888;
			width: 600px;
			text-align: center;
		}

		.close {
			color: #aaa;
			float: right;
			font-size: 28px;
			font-weight: bold;
		}

		.close:hover,
		.close:focus {
			color: black;
			text-decoration: none;
			cursor: pointer;
		}
	</style>
	<script>
		function modifySuccess() {
			const successMessage = "회원 정보 수정이 정상적으로 처리됐습니다!";
			alert(successMessage);
			document.getElementById("successMessage").innerText = successMessage;
		}

		// 페이지가 로드될 때 URL에 'success' 파라미터가 있는지 확인하고, 있으면 modifySuccess 호출
		document.addEventListener("DOMContentLoaded", function () {
			const urlParams = new URLSearchParams(window.location.search);
			if (urlParams.has('success')) {
				modifySuccess();
			}
		});

		function validPassword() {
			const newPassword1 = document.getElementById('newpassword1').value;
			const newPassword2 = document.getElementById('newpassword2').value;
			const inputResult = document.getElementById('inputResult');
			let errorMessage = "";

			// 새 비밀번호가 비어 있는 경우 유효성 검사를 건너뜀
			if (newPassword1 === "" && newPassword2 === "") {
				inputResult.innerHTML = "";
				return true;
			}

			// 비밀번호 길이 및 조합 규칙 확인
			if (newPassword1.length < 8 || newPassword1.length > 12 || !/^(?=.*[a-zA-Z])(?=.*[0-9])(?=.*\W).{8,12}$/.test(newPassword1)) {
				errorMessage += "비밀번호는 영문, 숫자, 특수문자를 조합하여 8~12자로 입력해주세요.\n";
			}

			// 비밀번호 일치 확인
			if (newPassword1 !== newPassword2) {
				errorMessage += "비밀번호가 일치하지 않습니다.";
			}

			if (errorMessage) {
				inputResult.innerHTML = errorMessage;
				inputResult.style.color = "red";
				return false; // 폼 제출을 막음
			} else {
				inputResult.innerHTML = "비밀번호가 일치합니다.";
				inputResult.style.color = "blue";
				return true; // 폼 제출을 허용
			}
		}


		// 모달 열기 함수
		function openConfirmModal() {
			var modal = document.getElementById('confirmModal');
			modal.style.display = 'block';
		}

		// 모달 닫기 함수
		function closeConfirmModal() {
			var modal = document.getElementById('confirmModal');
			modal.style.display = 'none';
		}

		function checkConfirmation() {
			var userInput = document.getElementById('confirmText').value.trim();
			if (userInput === '회원탈퇴') {
				document.getElementById('deleteForm').submit();
			} else {
				alert('입력한 문구가 일치하지 않습니다. "회원탈퇴"라고 정확히 입력해주세요.');
			}
		}
	</script>
</head>

<body>
	<div class="form-container" layout:fragment="content">
		<form th:action="@{|/user/mypage/${userTable.loginId}|}" th:object="${userTable}" method="post"
			onsubmit="return validPassword()">
			<div class="form-group">
				<label for="username">아이디</label>
				<input type="text" class="form-control" id="username" th:value="${userTable.loginId}" readonly>
			</div>
			<div class="form-group">
				<label for="currentPassword">현재 비밀번호</label>
				<input type="password" class="form-control" id="currentPassword" name="currentPassword"
					placeholder="현재 비밀번호를 입력해주세요.">
				<div th:if="${#fields.hasGlobalErrors()}" class="error-message">
					<p th:each="err : ${#fields.globalErrors()}" th:text="${err}"
						style="color: #ff0000; font-size: 12px"></p>
				</div>
			</div>
			<div class="form-group">
				<label for="newpassword1">새 비밀번호</label>
				<input type="password" class="form-control" id="newpassword1" name="newpassword1"
					placeholder="변경하실 비밀번호를 입력해주세요" oninput="validPassword()">
			</div>
			<div class="form-group">
				<label for="newpassword2">새 비밀번호 확인</label>
				<input type="password" class="form-control" id="newpassword2" name="newpassword2"
					placeholder="비밀번호 다시 입력해주세요" oninput="validPassword()">
				<div id="inputResult"></div>
			</div>
			<div class="form-group">
				<label for="name">이름</label>
				<input type="text" class="form-control" id="name" th:field="*{name}">
			</div>
			<div class="form-group">
				<label for="phoneNumber">전화번호</label>
				<input type="text" class="form-control" id="phoneNumber" th:field="*{phoneNumber}">
			</div>
			<div class="form-group gender">
				<label>성별</label>
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" id="male" th:field="*{gender}" value="male"
						th:checked="${userTable.gender == 'male'}">
					<label class="form-check-label" for="male">남자</label>
				</div>
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" id="female" th:field="*{gender}" value="female"
						th:checked="${userTable.gender == 'female'}">
					<label class="form-check-label" for="female">여자</label>
				</div>
			</div>
			<div style="text-align: center;">
				<button type="submit" class="btn btn-primary mb-2" style="width: 250px;">회원 정보 수정</button>
			</div>
		</form>
		<form id="deleteForm" action="/user/delete" method="post">
			<input type="hidden" name="_csrf" th:value="${_csrf.token}" />
			<div style="text-align: center;">
				<button type="button" class="exit btn btn-primary"
					style="width:250px; background-color: #ff0000; border: none;" onclick="openConfirmModal()">회원 탈퇴
				</button>
			</div>
		</form>

		<div id="confirmModal" class="modal" style="width: 100%">
			<div class="modal-content">
				<div class="d-flex" style="justify-content: space-between; align-items: center;">
					<p>회원 탈퇴를 하시려면 아래에 "회원탈퇴"를 입력해주세요</p>
					<p class="close" onclick="closeConfirmModal()" style="font-size: 50px; cursor: pointer;">&times;</p>
				</div>
				<input type="text" id="confirmText" placeholder="회원탈퇴">
				<button class="mt-2" onclick="checkConfirmation()">확인</button>
			</div>
		</div>
</body>

</html>